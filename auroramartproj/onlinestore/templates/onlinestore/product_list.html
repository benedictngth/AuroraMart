{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuroraMart | {{ page_title }}</title>
    <link rel="stylesheet" href="{% static 'onlinestore/css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'onlinestore/css/product_style.css' %}" />

  </head>
  <body>
    {% include 'onlinestore/_navBar.html'%}

    <main class="product-listing-content">
      <h1 class="page-header">{{ page_title }}</h1>

      {% if products %}
      <div class="product-grid">
        {% for product in products %}
        <div class="product-card">
          <h2 class="product-name">
            {% if product.pk %}
            <a href="{% url 'product_detail' product.pk %}?{% if category_id %}category={{ category_id }}{% endif %}{% if subcategory_id %}&subcategory={{ subcategory_id }}{% endif %}">
              {{ product.product_name }}
            </a>
            {% else %} {{ product.product_name }} (Invalid Product) {% endif %}
          </h2>
          <p class="product-sku">SKU: {{ product.sku_code }}</p>
          <p class="product-price">${{ product.unit_price }}</p>
          <p class="product-rating">
            Rating: â˜… {{ product.product_rating|default:"N/A" }}
          </p>

          {% if product.quantity_on_hand == 0 %}
          <p class="product-stock stock-out">Out of Stock</p>
          {% elif product.quantity_on_hand < 10 %}
          <p class="product-stock stock-low">
            Low Stock ({{ product.quantity_on_hand }} units)
          </p>
          {% else %}
          <p class="product-stock stock-available">Available</p>
          {% endif %}
          <div class="product-actions" id="product-actions-{{ product.sku_code }}">
            <a href="{% url 'product_detail' product_pk=product.pk %}?{% if category_id %}category={{ category_id }}{% endif %}{% if subcategory_id %}&subcategory={{ subcategory_id }}{% endif %}" class="view-details-link">
              <button class="view-details-btn" type="button">View Details</button>
            </a>

            {% if product.cart_quantity > 0 %}
                <form 
                    action="{% url 'add_to_cart' product_pk=product.pk %}" 
                    method="post" 
                    class="quantity-form"
                    data-product-max="{{ product.quantity_on_hand }}"
                >
                    {% csrf_token %}
                    {% if request.GET.category %}
                        <input type="hidden" name="category" value="{{ request.GET.category }}">
                    {% endif %}
                    {% if request.GET.subcategory %}
                        <input type="hidden" name="subcategory" value="{{ request.GET.subcategory }}">
                    {% endif %}
                    <div class="quantity-controls">
                        <button type="button" class="quantity-minus-btn" data-sku="{{ product.sku_code }}">-</button>
                        <span class="quantity-display" id="qty-display-{{ product.sku_code }}">{{ product.cart_quantity }}</span>
                        <button type="button" class="quantity-plus-btn" data-sku="{{ product.sku_code }}">+</button>
                    </div>

                    <input type="hidden" name="quantity" id="qty-input-{{ product.sku_code }}" value="{{ product.cart_quantity }}">
                    <input type="hidden" name="update" value="True"> 
                </form>
            {% else %}
                <form action="{% url 'add_to_cart' product_pk=product.pk %}" method="post" class="add-to-cart-form-initial">
                    {% csrf_token %}
                    {% if request.GET.category %}
                        <input type="hidden" name="category" value="{{ request.GET.category }}">
                    {% endif %}

                    {% if request.GET.subcategory %}
                        <input type="hidden" name="subcategory" value="{{ request.GET.subcategory }}">
                    {% endif %}

                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="add-to-cart-btn-initial" 
                            {% if product.quantity_on_hand == 0 %}disabled{% endif %}>
                        Add to Cart
                    </button>
                </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="no-results">
        Sorry, no products were found matching your criteria.
      </p>
      {% endif %}
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
          const productGrid = document.querySelector('.product-grid');

          if (!productGrid) return; 

          productGrid.addEventListener('click', (event) => {
              let button = event.target;
              let increment;

              if (button.classList.contains('quantity-plus-btn')) {
                  increment = 1;
              } else if (button.classList.contains('quantity-minus-btn')) {
                  increment = -1;
              } else {
                  return;
              }

              const form = button.closest('.quantity-form');
              if (!form) return;

              const sku = button.dataset.sku;
              const hiddenInput = document.getElementById(`qty-input-${sku}`);
              const display = document.getElementById(`qty-display-${sku}`);
              
              const maxQuantity = parseInt(form.getAttribute('data-product-max'), 10);
              
              let currentQuantity = parseInt(hiddenInput.value, 10);
              let newQuantity = currentQuantity + increment;
              
              if (newQuantity < 0) {
                  newQuantity = 0; 
              } 
              
              if (newQuantity > maxQuantity) {
                  console.warn("Cannot add more than stock on hand.");
                  return; 
              }

              display.textContent = newQuantity;
              hiddenInput.value = newQuantity;

              form.submit();
          });
      });
    </script>
  </body>
</html>
