{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuroraMart | {{ page_title }}</title>
    <link rel="stylesheet" href="{% static 'onlinestore/css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'onlinestore/css/product_style.css' %}" />

  </head>
  <body>
    {% include 'onlinestore/_navBar.html'%}

    <main class="product-listing-content">
      <h1 class="page-header">{{ page_title }}</h1>

      {% if breadcrumb and breadcrumb|length > 1 %}
        <div class="breadcrumb-trail">
        {% for item in breadcrumb %}
          <a href="{{ item.url }}" class="breadcrumb-link">{{ item.name }}</a>
          {% if not forloop.last %}
            <span class="breadcrumb-separator">></span>
          {% endif %}
        {% endfor %}
        </div>
      {% endif %}
      
      {% if products %}
      <div class="product-page-layout">
        <div class="filter-sidebar">
          <h2>Filter Products</h2>

          <form method="get" id="filter-form">

            {% if category_id %}
              <input type="hidden" name="category" value="{{ category_id }}">
            {% endif %}
            {% if subcategory_id %}
              <input type="hidden" name="subcategory" value="{{ subcategory_id }}">
            {% endif %}
            {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
            {% endif %}

            {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}">
            {% endif %}

            <div class="filter-group">
                <label for="{{ filter_form.min_rating.id_for_label }}">Minimum Rating</label>
                {{ filter_form.min_rating }}
            </div>

            <div class="filter-group">
                <label for="{{ filter_form.price_range.id_for_label }}">Price Range</label>
                {{ filter_form.price_range }}
            </div>

            <a href="{% url 'product_list' %}?{% if category_id %}category={{ category_id }}{% endif %}{% if subcategory_id %}&subcategory={{ subcategory_id }}{% endif %}" class="view-details-btn" style="width: 100%; margin-top: 10px; background-color: #f0ad4e; text-align: center;">Clear Filters</a>

          </form>
      </div>

      <div class="product-content-area">
        <div class="product-listing-header">
          <p class="product-count">
            Showing <strong>{{ total_count }}</strong> products.
          </p>

          <form method="get" class="sort-controls" id="sort-form">
            <label for="id_sort" class="sort-label">Sort By:</label>
            
            {{ sort_form.sort }}
            
            {% if category_id %}
              <input type="hidden" name="category" value="{{ category_id }}">
            {% endif %}
            {% if subcategory_id %}
              <input type="hidden" name="subcategory" value="{{ subcategory_id }}">
            {% endif %}
            {% if request.GET.min_rating %}
                <input type="hidden" name="min_rating" value="{{ request.GET.min_rating }}">
            {% endif %}
            {% if request.GET.price_range %}
                <input type="hidden" name="price_range" value="{{ request.GET.price_range }}">
            {% endif %}

            {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}">
            {% endif %}

            <button type="submit" class="sort-submit-btn">Sort</button>
          </form>
        </div>

        <div class="product-grid">
          {% for product in products %}
          <div class="product-card">
            <h2 class="product-name">
              {% if product.pk %}
              <a href="{% url 'product_detail' product.pk %}?{% if category_id %}category={{ category_id }}{% endif %}{% if subcategory_id %}&subcategory={{ subcategory_id }}{% endif %}">
                {{ product.product_name }}
              </a>
              {% else %} {{ product.product_name }} (Invalid Product) {% endif %}
            </h2>
            <p class="product-sku">SKU: {{ product.sku_code }}</p>
            <p class="product-price">${{ product.unit_price }}</p>
            <p class="product-rating">
              Rating: â˜… {{ product.product_rating|default:"N/A" }}
            </p>

            {% if product.quantity_on_hand == 0 %}
            <p class="product-stock stock-out">Out of Stock</p>
            {% elif product.quantity_on_hand < 10 %}
            <p class="product-stock stock-low">
              Low Stock ({{ product.quantity_on_hand }} units)
            </p>
            {% else %}
            <p class="product-stock stock-available">Available</p>
            {% endif %}
            <div class="product-actions" id="product-actions-{{ product.sku_code }}">
              <a href="{% url 'product_detail' product_pk=product.pk %}?{% if category_id %}category={{ category_id }}{% endif %}{% if subcategory_id %}&subcategory={{ subcategory_id }}{% endif %}" class="view-details-link">
                <button class="view-details-btn" type="button">View Details</button>
              </a>

              {% if product.cart_quantity > 0 %}
                  <div class="in-cart-info">
                      <p>In Cart: {{ product.cart_quantity }}</p>
                      <a href="{% url 'cart_detail' %}" class="edit-in-cart-link">Edit in Cart</a>
                  </div>
              {% else %}
                  <form action="{% url 'add_to_cart' product_pk=product.pk %}" method="post" class="add-to-cart-form-initial">
                      {% csrf_token %}
                      {% if request.GET.category %}
                          <input type="hidden" name="category" value="{{ request.GET.category }}">
                      {% endif %}

                      {% if request.GET.subcategory %}
                          <input type="hidden" name="subcategory" value="{{ request.GET.subcategory }}">
                      {% endif %}

                      <input type="hidden" name="quantity" value="1">
                      <button type="submit" class="add-to-cart-btn-initial" 
                              {% if product.quantity_on_hand == 0 %}disabled{% endif %}>
                          Add to Cart
                      </button>
                  </form>
              {% endif %}
              </div>
              </div>
              {% endfor %}
            </div>
          </div>

        </div>
      </div>
      {% else %}
      <p class="no-results">
        Sorry, no products were found matching your criteria.
      </p>
      {% endif %}
    </main>

  </body>
</html>
